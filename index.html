<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VGV KOL Radar Engineï¼ˆYouTube TOP100 æ±ºç­–æ± ï¼‰</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Microsoft JhengHei',sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:18px;
    }
    .container{max-width:1500px;margin:0 auto}
    .header{
      background:#fff;padding:26px;border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);margin-bottom:18px;text-align:center
    }
    .header h1{color:#4f63e6;font-size:2.1em;margin-bottom:8px}
    .header p{color:#666;font-size:1.02em}
    .panel{
      background:#fff;padding:18px;border-radius:16px;
      box-shadow:0 6px 22px rgba(0,0,0,.10);margin-bottom:18px;
    }
    .grid{display:grid;grid-template-columns: 1.2fr 1fr; gap:18px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .row{display:grid;grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px; margin:10px 0 12px}
    @media (max-width: 980px){ .row{grid-template-columns:1fr 1fr} }
    label{display:block;color:#333;font-weight:600;margin-bottom:6px;font-size:.95em}
    select, input{
      width:100%;padding:10px;border:2px solid #e8e8e8;border-radius:10px;font-size:15px;background:#fff
    }
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    button{
      padding:10px 14px;border:0;border-radius:10px;
      background:#4f63e6;color:#fff;font-weight:700;cursor:pointer;
      box-shadow:0 8px 18px rgba(79,99,230,.25);
      transition:transform .15s, background .15s
    }
    button:hover{background:#4457d9;transform:translateY(-1px)}
    button.secondary{background:#111827;box-shadow:0 8px 18px rgba(17,24,39,.18)}
    button.secondary:hover{background:#0b1220}
    .note{
      margin-top:10px; padding:10px 12px; border-radius:12px;
      background:#f8f9ff; color:#4b5563; line-height:1.45; font-size:.95em;
      border:1px solid #e8ebff
    }
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .badge{
      display:inline-flex;gap:8px;align-items:center;
      padding:7px 10px;border-radius:999px;background:#f3f4f6;color:#111827;font-weight:700;font-size:.9em
    }
    .badge span{font-weight:800;color:#4f63e6}
    .status{margin-top:10px;color:#111827;font-weight:700}
    .status small{font-weight:600;color:#6b7280}
    .error{margin-top:10px;padding:12px;border-radius:12px;background:#fee2e2;color:#991b1b;font-weight:700}
    .ok{margin-top:10px;padding:12px;border-radius:12px;background:#dcfce7;color:#166534;font-weight:700}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    thead th{
      position:sticky;top:0;background:#fff;z-index:1;
      text-align:left;font-size:.92em;color:#111827;padding:10px 10px;border-bottom:2px solid #e5e7eb;
      cursor:pointer; user-select:none
    }
    tbody td{
      padding:10px 10px;border-bottom:1px solid #eef2ff;color:#111827;font-size:.95em; vertical-align:middle
    }
    tbody tr:hover{background:#f8f9ff}
    .rank{font-weight:900;color:#4f63e6}
    .muted{color:#6b7280;font-weight:600}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:44px;padding:5px 10px;border-radius:999px;font-weight:900;font-size:.88em
    }
    .pill.A{background:#dcfce7;color:#166534}
    .pill.B{background:#dbeafe;color:#1d4ed8}
    .pill.C{background:#fef3c7;color:#92400e}
    .pill.D{background:#fee2e2;color:#991b1b}
    .link{color:#4f63e6;font-weight:800;text-decoration:none}
    .link:hover{text-decoration:underline}
    .small{font-size:.88em;color:#6b7280;font-weight:600}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .search{
      display:flex;gap:10px;align-items:center;flex:1; min-width:220px
    }
    .search input{flex:1}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ“¡ VGV KOL Radar Engine</h1>
    <p>å…§éƒ¨é¸ KOL æ±ºç­–å·¥å…·ï½œå…§å®¹èªè¨€ Ã— è§€çœ¾åœ°å€ Ã— è¡ŒéŠ·å“é¡ï½œTOP 100 æ±ºç­–æ± </p>
  </div>

  <div class="panel">
    <div class="toolbar">
      <div class="search">
        <input id="quickSearch" placeholder="å¿«é€Ÿæœå°‹ï¼ˆé »é“å / ID / è‡ªè¨‚ç¶²å€ï¼‰â€¦" />
        <button class="secondary" onclick="applyQuickSearch()">æœå°‹</button>
      </div>
      <div class="right">
        <button onclick="runTop100()">åˆ·æ–° TOP100</button>
        <button class="secondary" onclick="exportCSV()">åŒ¯å‡º CSV</button>
      </div>
    </div>

    <div class="row">
      <div>
        <label>è§€çœ¾åœ°å€ï¼ˆregionCodeï¼‰</label>
        <select id="region">
          <option value="TW">å°ç£ ğŸ‡¹ğŸ‡¼</option>
          <option value="HK">é¦™æ¸¯ ğŸ‡­ğŸ‡°</option>
          <option value="SG">æ–°åŠ å¡ ğŸ‡¸ğŸ‡¬</option>
          <option value="MY">é¦¬ä¾†è¥¿äº ğŸ‡²ğŸ‡¾</option>
          <option value="JP">æ—¥æœ¬ ğŸ‡¯ğŸ‡µ</option>
          <option value="KR">éŸ“åœ‹ ğŸ‡°ğŸ‡·</option>
          <option value="US">ç¾åœ‹ ğŸ‡ºğŸ‡¸</option>
          <option value="GB">è‹±åœ‹ ğŸ‡¬ğŸ‡§</option>
        </select>
      </div>
      <div>
        <label>å…§å®¹èªè¨€ï¼ˆrelevanceLanguageï¼‰</label>
        <select id="lang">
          <option value="zh-Hant">ç¹é«”ä¸­æ–‡ï¼ˆzh-Hantï¼‰</option>
          <option value="zh-Hans">ç°¡é«”ä¸­æ–‡ï¼ˆzh-Hansï¼‰</option>
          <option value="en">è‹±æ–‡ï¼ˆenï¼‰</option>
          <option value="ja">æ—¥æ–‡ï¼ˆjaï¼‰</option>
          <option value="ko">éŸ“æ–‡ï¼ˆkoï¼‰</option>
        </select>
      </div>
      <div>
        <label>è¡ŒéŠ·å“é¡ï¼ˆMarketing Categoryï¼‰</label>
        <select id="cat">
          <option value="3c">3C ç§‘æŠ€</option>
          <option value="lifestyle">ç”Ÿæ´»é¢¨æ ¼</option>
          <option value="food">ç¾é£Ÿæ–™ç†</option>
          <option value="parenting">è¦ªå­æ¯å¬°</option>
          <option value="finance">è²¡ç¶“æŠ•è³‡</option>
          <option value="travel">æ—…éŠ</option>
          <option value="fitness">å¥èº«</option>
        </select>
      </div>
      <div>
        <label>æœŸé–“ï¼ˆå¤©ï¼‰</label>
        <select id="days">
          <option value="30">30</option>
          <option value="90">90</option>
          <option value="180">180</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <label style="display:flex;gap:8px;align-items:center;font-weight:700;color:#111827">
        <input type="checkbox" id="excludeTopic" checked />
        æ’é™¤ Topic / å®˜æ–¹éŸ³æ¨‚é¡å™ªéŸ³
      </label>
      <label style="display:flex;gap:8px;align-items:center;font-weight:700;color:#111827">
        <input type="checkbox" id="strictLang" checked />
        åš´æ ¼èªè¨€éæ¿¾ï¼ˆæå‡ç²¾æº–ï¼Œå¯èƒ½æ¸›å°‘æ¨£æœ¬ï¼‰
      </label>
      <label style="display:flex;gap:8px;align-items:center;font-weight:700;color:#111827">
        <input type="checkbox" id="strictCat" checked />
        åš´æ ¼å“é¡å»åˆï¼ˆéœ€é”æ¨™æ‰ç´å…¥ TOP100ï¼‰
      </label>
      <label style="display:flex;gap:8px;align-items:center;font-weight:700;color:#111827">
        <input type="checkbox" id="useCache" checked />
        ä½¿ç”¨å¿«å–ï¼ˆçœ quotaã€é€Ÿåº¦æ›´å¿«ï¼‰
      </label>
    </div>

    <div class="badges" id="badges"></div>

    <div class="note">
      <b>æ¦œå–®ä¾æ“šï¼š</b>
      ä»¥ã€Œ<b>è§€çœ¾åœ°å€</b>ï¼ˆregionCodeï¼‰ã€ç‚ºå…¥å£ï¼Œå…ˆæ“´å¤§æŠ“å–å€™é¸é »é“ï¼ˆå¤š queryã€å¤šé ï¼‰ï¼Œå†ä»¥ã€Œ<b>å…§å®¹èªè¨€</b> + <b>è¡ŒéŠ·å“é¡</b>ï¼ˆé—œéµå­—èªæ„è¦å‰‡ï¼‰ã€åšäºŒæ¬¡éæ¿¾ï¼Œ
      å°æ¯å€‹å€™é¸é »é“æ‹‰å–è¿‘ 20 æ”¯ä¸Šå‚³å½±ç‰‡çš„çµ±è¨ˆè³‡æ–™ï¼Œè¨ˆç®— <b>VGV Decision Score</b>ï¼ˆè§¸åŠ Ã— äº’å‹• Ã— æˆé•· Ã— ç©©å®š Ã— ç•™è¨€ï¼‰ï¼Œæœ€å¾Œè¼¸å‡º TOP 100 æ±ºç­–æ± ã€‚
      <div class="small" style="margin-top:6px">â€» é€™æ˜¯ã€Œå…§éƒ¨æ±ºç­–æ± ã€ä¸æ˜¯ã€Œå®˜æ–¹ YouTube æ’è¡Œæ¦œã€ï¼Œç›®æ¨™æ˜¯è®“ AM/AE åœ¨ 10 åˆ†é˜å…§ç¸®å°å¯åˆä½œåå–®ã€‚</div>
    </div>

    <div id="msg" class="status">å°šæœªè¼‰å…¥ã€‚<small>ï¼ˆæŒ‰ã€Œåˆ·æ–° TOP100ã€é–‹å§‹ï¼‰</small></div>
    <div id="alert"></div>

    <div style="overflow:auto; margin-top:10px; border-radius:14px; border:1px solid #eef2ff">
      <table id="tbl">
        <thead>
          <tr>
            <th data-k="rank">#</th>
            <th data-k="title">é »é“</th>
            <th data-k="tier">Tier</th>
            <th data-k="score">Decision Score</th>
            <th data-k="subs">è¨‚é–±</th>
            <th data-k="avgViews">è¿‘æœŸé–“å¹³å‡è§€çœ‹</th>
            <th data-k="engRate">äº’å‹•ç‡</th>
            <th data-k="growth">æˆé•·å‹•èƒ½</th>
            <th data-k="stability">è§€çœ‹ç©©å®š</th>
            <th data-k="commentsK">ç•™è¨€/åƒæ¬¡è§€çœ‹</th>
            <th data-k="match">å“é¡å»åˆ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <div class="panel">
    <h2 style="color:#111827; font-size:1.2em; margin-bottom:10px">ğŸ”§ é€£ç·šè¨­å®šï¼ˆå®‰å…¨ç‰ˆï¼‰</h2>
    <div class="note">
      é€™å€‹å®Œæ•´ç‰ˆæ¡ç”¨ <b>å¾Œç«¯ä»£ç†ï¼ˆCloudflare Workerï¼‰</b>ï¼šAPI Key å­˜åœ¨å¾Œç«¯ç’°å¢ƒè®Šæ•¸ï¼Œä¸æœƒæš´éœ²åœ¨ GitHub Pagesã€‚
      å‰ç«¯åªå‘¼å«ä½ çš„ Workerï¼š<code id="apiBaseHint"></code>
    </div>
    <div class="row" style="grid-template-columns: 1fr 1fr;">
      <div>
        <label>Worker API Baseï¼ˆä¾‹å¦‚ï¼šhttps://xxx.workers.devï¼‰</label>
        <input id="apiBase" placeholder="è¼¸å…¥ä½ çš„ Worker ç¶²å€" />
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="actions">
          <button class="secondary" onclick="saveApiBase()">å„²å­˜</button>
          <button onclick="ping()">æ¸¬è©¦é€£ç·š</button>
        </div>
      </div>
    </div>
    <div id="pingResult"></div>
  </div>

</div>

<script>
  // ========= åŸºæœ¬è¨­å®š =========
// ä¸»è¦å„²å­˜ keyï¼ˆå›ºå®šï¼‰ï¼š
const LS_API_BASE = "VGV_WORKER_API_BASE";

// èˆŠç‰ˆç›¸å®¹ï¼ˆå¦‚æœä½ ä¹‹å‰å­˜éå…¶ä»– keyï¼Œæœƒè‡ªå‹•æ¬ç§»ï¼‰ï¼š
const LEGACY_API_BASE_KEYS = ["VGV_API_BASE", "VGV_WORKER_API", "VGV_API_BASE_URL"];

// é è¨­ Workerï¼ˆå»ºè­°ç›´æ¥å›ºå®šï¼Œé¿å…ç©ºå€¼å°è‡´æ‰“åˆ° GitHub Pages è®Šæˆ 404/HTMLï¼‰
const DEFAULT_API_BASE = "https://youtube.aaron-9b6.workers.dev";

// è®€å–ï¼šè‹¥ localStorage æ˜¯ç©ºå­—ä¸²/ç©ºç™½ï¼Œä¸€å¾‹å›é€€åˆ° DEFAULT
function loadApiBase() {
  let v = (localStorage.getItem(LS_API_BASE) || "").trim();
  if (!v) {
    // legacy migration
    for (const k of LEGACY_API_BASE_KEYS) {
      const legacy = (localStorage.getItem(k) || "").trim();
      if (legacy) {
        v = legacy;
        localStorage.setItem(LS_API_BASE, v);
        break;
      }
    }
  }
  return v || DEFAULT_API_BASE;
}

let API_BASE = loadApiBase();

  const table = document.getElementById("tbl");
  const tbody = table.querySelector("tbody");
  const msg = document.getElementById("msg");
  const alertBox = document.getElementById("alert");
  const badges = document.getElementById("badges");
  const apiBaseInput = document.getElementById("apiBase");
  const apiBaseHint = document.getElementById("apiBaseHint");

  apiBaseInput.value = API_BASE || "";
  apiBaseHint.textContent = API_BASE || "ï¼ˆå°šæœªè¨­å®šï¼‰";

  // æ’åºç‹€æ…‹
  let currentRows = [];
  let sortKey = "rank";
  let sortAsc = true;

  // å¿«å– last result
  let lastResult = null;
  let lastQuery = null;

  function setAlert(type, text){
    if(!text){ alertBox.innerHTML = ""; return; }
    const cls = type === "error" ? "error" : "ok";
    alertBox.innerHTML = `<div class="${cls}">${escapeHtml(text)}</div>`;
  }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }


  // ä»¥ã€Œæ–‡å­—ã€å…ˆè®€å–ï¼Œé¿å…æŠŠ HTML ç•¶ JSON è§£æï¼ˆä½ ç›®å‰é‡åˆ°çš„ <!DOCTYPE ...> å•é¡Œï¼‰
  async function fetchJSONSafe(url, opts){
    const r = await fetch(url, opts);
    const ct = (r.headers.get("content-type") || "").toLowerCase();
    const text = await r.text();

    // å˜—è©¦è§£æ JSON
    if(ct.includes("application/json") || text.trim().startsWith("{") || text.trim().startsWith("[")){
      let j = null;
      try { j = JSON.parse(text); } catch(e){
        const preview = text.slice(0, 200);
        throw new Error(`å›å‚³ä¸æ˜¯æœ‰æ•ˆ JSONï¼ˆ${r.status}ï¼‰ï¼š${preview}`);
      }
      if(!r.ok){
        throw new Error((j && j.error) ? j.error : (`HTTP ${r.status}`));
      }
      return j;
    }

    // é JSONï¼šå¤šåŠæ˜¯ 404/éŒ¯èª¤é  HTML
    const preview = text.replace(/\s+/g," ").slice(0, 180);
    throw new Error(`å›å‚³é JSONï¼ˆ${r.status}ï¼‰ã€‚å¾ˆå¯èƒ½ API_BASE ç‚ºç©ºæˆ–è·¯å¾‘éŒ¯èª¤ã€‚å…§å®¹é è¦½ï¼š${preview}`);
  }
  function getSettings(){
    return {
      region: document.getElementById("region").value,
      lang: document.getElementById("lang").value,
      cat: document.getElementById("cat").value,
      days: Number(document.getElementById("days").value),
      excludeTopic: document.getElementById("excludeTopic").checked,
      strictLang: document.getElementById("strictLang").checked,
      strictCat: document.getElementById("strictCat").checked,
      useCache: document.getElementById("useCache").checked,
    };
  }

  function renderBadges(s){
    const catLabel = {
      "3c":"3C ç§‘æŠ€","lifestyle":"ç”Ÿæ´»é¢¨æ ¼","food":"ç¾é£Ÿæ–™ç†",
      "parenting":"è¦ªå­æ¯å¬°","finance":"è²¡ç¶“æŠ•è³‡","travel":"æ—…éŠ","fitness":"å¥èº«"
    }[s.cat] || s.cat;

    badges.innerHTML = `
      <div class="badge">åœ°å€ <span>${escapeHtml(s.region)}</span></div>
      <div class="badge">èªè¨€ <span>${escapeHtml(s.lang)}</span></div>
      <div class="badge">å“é¡ <span>${escapeHtml(catLabel)}</span></div>
      <div class="badge">æœŸé–“ <span>${escapeHtml(s.days)} å¤©</span></div>
      <div class="badge">ç›®æ¨™ <span>TOP 100</span></div>
    `;
  }

  function saveApiBase(){
    API_BASE = (apiBaseInput.value || "").trim();
    if(API_BASE.endsWith("/")) API_BASE = API_BASE.slice(0, -1);

    // ç©ºå€¼å°±ä¸è¦å­˜ï¼ˆé¿å… API_BASE è®Šæˆ ""ï¼Œå°è‡´è«‹æ±‚æ‰“åˆ° GitHub Pages ç”¢ç”Ÿ 404/HTMLï¼‰
    if(!API_BASE){
      localStorage.removeItem(LS_API_BASE);
      API_BASE = DEFAULT_API_BASE;
      apiBaseInput.value = API_BASE;
      apiBaseHint.textContent = API_BASE;
      setAlert("ok", "âœ… å·²æ¸…é™¤è‡ªè¨‚ API Baseï¼Œæ”¹ç”¨é è¨­ Workerã€‚");
      return;
    }

    localStorage.setItem(LS_API_BASE, API_BASE);
    apiBaseHint.textContent = API_BASE;
    setAlert("ok", "âœ… å·²å„²å­˜ Worker API Baseã€‚");
  }

  async function ping(){
    setAlert();
    const base = (apiBaseInput.value || "").trim();
    if(!base){
      setAlert("error", "âŒ è«‹å…ˆè¼¸å…¥ Worker API Baseã€‚");
      return;
    }
    try{
      const j = await fetchJSONSafe(base.replace(/\/$/,"") + "/ping", { cache:"no-store" });
      document.getElementById("pingResult").innerHTML =
        `<div class="ok">âœ… é€£ç·šæˆåŠŸï¼š${escapeHtml(JSON.stringify(j))}</div>`;
    }catch(e){
      document.getElementById("pingResult").innerHTML =
        `<div class="error">âŒ é€£ç·šå¤±æ•—ï¼š${escapeHtml(e.message || String(e))}</div>`;
    }
  }

  function fmtNum(n){
    const num = Number(n || 0);
    if(num >= 1e6) return (num/1e6).toFixed(1)+"M";
    if(num >= 1e3) return (num/1e3).toFixed(1)+"K";
    return String(Math.round(num));
  }
  function fmtPct(x, digits=2){
    const v = Number(x || 0)*100;
    return (v>=0? "" : "-") + Math.abs(v).toFixed(digits) + "%";
  }
  function fmt1(x){ return Number(x || 0).toFixed(1); }

  function tierOf(score){
    const s = Number(score || 0);
    if(s >= 80) return "A";
    if(s >= 65) return "B";
    if(s >= 50) return "C";
    return "D";
  }

  function buildRow(r, idx){
    const t = tierOf(r.score);
    const url = "https://www.youtube.com/channel/" + encodeURIComponent(r.channelId);
    const cUrl = r.customUrl ? ("https://www.youtube.com/" + r.customUrl.replace(/^@/,"@")) : url;

    return `
      <tr>
        <td class="rank">${idx+1}</td>
        <td>
          <div style="display:flex; gap:10px; align-items:center; min-width:260px">
            <img src="${escapeHtml(r.thumbnail || "")}" style="width:44px;height:44px;border-radius:50%" alt="">
            <div style="min-width:0">
              <a class="link" href="${escapeHtml(cUrl)}" target="_blank" rel="noopener">${escapeHtml(r.title || "")}</a>
              <div class="small">${escapeHtml(r.customUrl || r.channelId || "")}</div>
            </div>
          </div>
        </td>
        <td><span class="pill ${t}">${t}</span></td>
        <td><b>${fmt1(r.score)}</b></td>
        <td>${fmtNum(r.subscriberCount)}</td>
        <td>${fmtNum(r.avgViews)}</td>
        <td>${fmtPct(r.engagementRate, 2)}</td>
        <td>${fmtPct(r.growthMomentum, 2)}</td>
        <td>${fmtPct(r.stabilityScore, 2)}</td>
        <td>${fmt1(r.commentsPerKViews)}</td>
        <td>${fmtPct(r.categoryMatch, 0)}</td>
      </tr>
    `;
  }

  function renderTable(rows){
    tbody.innerHTML = rows.map((r,i)=>buildRow(r,i)).join("");
  }

  function attachSort(){
    table.querySelectorAll("thead th").forEach(th=>{
      th.addEventListener("click", ()=>{
        const k = th.getAttribute("data-k");
        if(!k) return;
        if(sortKey === k) sortAsc = !sortAsc;
        else { sortKey = k; sortAsc = false; }
        sortRows();
      });
    });
  }

  function sortRows(){
    const rows = [...currentRows];
    const dir = sortAsc ? 1 : -1;

    rows.sort((a,b)=>{
      const av = a[sortKey];
      const bv = b[sortKey];
      if(sortKey === "title" || sortKey === "tier"){
        return String(av||"").localeCompare(String(bv||""), "zh-Hant") * dir;
      }
      return (Number(av||0) - Number(bv||0)) * dir;
    });

    renderTable(rows);
  }

  function applyQuickSearch(){
    const q = (document.getElementById("quickSearch").value || "").trim().toLowerCase();
    if(!lastResult){ setAlert("error","âŒ å°šæœªè¼‰å…¥æ¦œå–®ã€‚"); return; }
    if(!q){
      currentRows = lastResult.items || [];
      sortRows();
      setAlert("ok", "âœ… å·²æ¸…é™¤æœå°‹æ¢ä»¶ã€‚");
      return;
    }
    const filtered = (lastResult.items || []).filter(x=>{
      return (x.title||"").toLowerCase().includes(q)
        || (x.channelId||"").toLowerCase().includes(q)
        || (x.customUrl||"").toLowerCase().includes(q);
    });
    currentRows = filtered;
    sortRows();
    setAlert("ok", `âœ… ç¯©å‡º ${filtered.length} ç­†çµæœã€‚`);
  }

  function exportCSV(){
    if(!lastResult || !lastResult.items){ setAlert("error","âŒ å°šæœªè¼‰å…¥æ¦œå–®ï¼Œç„¡æ³•åŒ¯å‡ºã€‚"); return; }
    const s = lastQuery || getSettings();
    const catLabel = {"3c":"3Cç§‘æŠ€","lifestyle":"ç”Ÿæ´»é¢¨æ ¼","food":"ç¾é£Ÿæ–™ç†","parenting":"è¦ªå­æ¯å¬°","finance":"è²¡ç¶“æŠ•è³‡","travel":"æ—…éŠ","fitness":"å¥èº«"}[s.cat] || s.cat;

    const header = [
      "rank","tier","score","channelId","customUrl","title",
      "subscriberCount","avgViews","engagementRate","growthMomentum","stabilityScore","commentsPerKViews","categoryMatch",
      "region","lang","category","days","generatedAt"
    ];
    const lines = [header.join(",")];

    const generatedAt = lastResult.generatedAt || new Date().toISOString();
    (lastResult.items || []).forEach((r, idx)=>{
      const t = tierOf(r.score);
      const row = [
        idx+1, t, r.score, r.channelId, r.customUrl||"", `"${String(r.title||"").replaceAll('"','""')}"`,
        r.subscriberCount, r.avgViews, r.engagementRate, r.growthMomentum, r.stabilityScore, r.commentsPerKViews, r.categoryMatch,
        s.region, s.lang, catLabel, s.days, generatedAt
      ];
      lines.push(row.join(","));
    });

    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const fn = `VGV_TOP100_${s.region}_${s.lang}_${s.cat}_${s.days}d.csv`;
    a.download = fn;
    a.click();
    URL.revokeObjectURL(url);
    setAlert("ok", `âœ… å·²åŒ¯å‡º CSVï¼š${fn}`);
  }

  async function runTop100(){
    setAlert();
    const s = getSettings();
    renderBadges(s);

    if(!API_BASE){
      setAlert("error", "âŒ ä½ å°šæœªè¨­å®š Worker API Baseã€‚è«‹åœ¨ä¸‹æ–¹è¼¸å…¥å¾Œå„²å­˜ï¼Œä¸¦æŒ‰ã€Œæ¸¬è©¦é€£ç·šã€ã€‚");
      return;
    }

    msg.textContent = "â³ æ­£åœ¨ç”Ÿæˆ TOP 100 æ±ºç­–æ± â€¦ï¼ˆç¬¬ä¸€æ¬¡å¯èƒ½è¼ƒä¹…ï¼Œä¹‹å¾Œæœƒå¿«å¾ˆå¤šï¼‰";

    const qs = new URLSearchParams({
      region: s.region,
      lang: s.lang,
      cat: s.cat,
      days: String(s.days),
      excludeTopic: s.excludeTopic ? "1" : "0",
      strictLang: s.strictLang ? "1" : "0",
      strictCat: s.strictCat ? "1" : "0",
      cache: s.useCache ? "1" : "0"
    });

    try{
      const url = API_BASE + "/top100?" + qs.toString();
      const r = await fetch(url, { cache: "no-store" });
      const j = await r.json();
      if(!r.ok){
        throw new Error(j && j.error ? j.error : ("HTTP " + r.status));
      }

      lastResult = j;
      lastQuery = s;
      currentRows = j.items || [];

      msg.innerHTML = `âœ… ç”Ÿæˆå®Œæˆï¼š<b>${currentRows.length}</b> ç­†ï½œ<small>generatedAt: ${escapeHtml(j.generatedAt || "")}</small>`;
      setAlert("ok", `âœ… å·²å–å¾— TOP100ï¼ˆå€™é¸æ± ï¼š${j.meta?.candidateChannels || "-"}ï¼Œç´å…¥ï¼š${currentRows.length}ï¼‰ã€‚`);

      sortKey = "score"; sortAsc = false;
      sortRows();

    }catch(e){
      console.error(e);
      msg.textContent = "âŒ ç”Ÿæˆå¤±æ•—ã€‚";
      setAlert("error", "âŒ ç”Ÿæˆå¤±æ•—ï¼š" + (e.message || String(e)));
    }
  }

  // åˆå§‹åŒ–
  attachSort();
  renderBadges(getSettings());
</script>
</body>
</html>
