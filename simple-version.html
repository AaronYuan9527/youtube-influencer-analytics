<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VGV YouTube å½±éŸ¿åŠ›åˆ†æå·¥å…·</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Microsoft JhengHei',sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:20px;
    }
    .container{max-width:1400px;margin:0 auto}
    .header{
      background:#fff;padding:30px;border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);margin-bottom:20px;text-align:center
    }
    .header h1{color:#667eea;font-size:2.2em;margin-bottom:8px}
    .header p{color:#666;font-size:1.05em}
    .panel{
      background:#fff;padding:20px;border-radius:16px;
      box-shadow:0 6px 22px rgba(0,0,0,.12);margin-bottom:20px;
    }
    .api-box{
      background:#f8f9ff;border:2px solid #e0e7ff;border-radius:12px;
      padding:16px;margin-bottom:20px;
    }
    .api-box input{
      width:calc(100% - 120px);padding:12px;border:2px solid #ddd;
      border-radius:8px;font-size:15px;margin-right:10px;
    }
    .api-box button{
      padding:12px 24px;background:#667eea;color:#fff;border:0;
      border-radius:8px;font-weight:700;cursor:pointer;transition:.2s;
    }
    .api-box button:hover{background:#5568d3}
    .note{
      background:#fef3c7;border-left:4px solid #f59e0b;
      padding:12px;border-radius:8px;margin-top:10px;font-size:.95em;color:#92400e;
    }
    .controls{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:12px;margin-bottom:16px;
    }
    label{display:block;color:#374151;font-weight:600;margin-bottom:6px;font-size:.9em}
    select,input{
      width:100%;padding:10px;border:2px solid #e5e7eb;
      border-radius:8px;font-size:14px;background:#fff;
    }
    .btn-group{display:flex;gap:10px;margin-top:16px;}
    button{
      padding:12px 20px;border:0;border-radius:8px;font-weight:700;
      cursor:pointer;transition:.2s;font-size:15px;
    }
    .btn-primary{background:#667eea;color:#fff}
    .btn-primary:hover{background:#5568d3}
    .btn-secondary{background:#6b7280;color:#fff}
    .btn-secondary:hover{background:#4b5563}
    .status{
      margin:16px 0;padding:12px;border-radius:8px;font-weight:600;
    }
    .status.loading{background:#dbeafe;color:#1e40af}
    .status.success{background:#d1fae5;color:#065f46}
    .status.error{background:#fee2e2;color:#991b1b}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    thead th{
      background:#f9fafb;text-align:left;padding:12px;
      border-bottom:2px solid #e5e7eb;font-size:.9em;color:#374151;
      position:sticky;top:0;cursor:pointer;user-select:none;
    }
    thead th:hover{background:#f3f4f6}
    tbody td{
      padding:12px;border-bottom:1px solid #f3f4f6;
      font-size:.95em;vertical-align:middle;
    }
    tbody tr:hover{background:#f9fafb}
    .channel-cell{display:flex;align-items:center;gap:12px}
    .channel-thumb{width:48px;height:48px;border-radius:50%;object-fit:cover}
    .channel-name{font-weight:600;color:#111827}
    .channel-id{font-size:.85em;color:#6b7280;margin-top:2px}
    .number{font-weight:700;color:#667eea}
    .tier{
      display:inline-block;padding:4px 12px;border-radius:999px;
      font-weight:800;font-size:.85em;
    }
    .tier-A{background:#d1fae5;color:#065f46}
    .tier-B{background:#dbeafe;color:#1e40af}
    .tier-C{background:#fef3c7;color:#92400e}
    .tier-D{background:#fee2e2;color:#991b1b}
    .link{color:#667eea;text-decoration:none;font-weight:600}
    .link:hover{text-decoration:underline}
    @media(max-width:768px){
      .controls{grid-template-columns:1fr}
      .api-box input{width:100%;margin-bottom:10px}
      .api-box button{width:100%}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ“Š VGV YouTube å½±éŸ¿åŠ›åˆ†æå·¥å…·</h1>
    <p>VGV åœˆç²‰è¡ŒéŠ·ç§‘æŠ€ - å°ˆæ¥­ KOL æ•¸æ“šåˆ†æ</p>
  </div>

  <div class="panel">
    <h3 style="color:#374151;margin-bottom:12px">ğŸ”‘ YouTube API è¨­å®š</h3>
    <div class="api-box">
      <input type="password" id="apiKey" placeholder="è«‹è¼¸å…¥æ‚¨çš„ YouTube Data API v3 é‡‘é‘°" />
      <button onclick="saveApiKey()">å„²å­˜</button>
      <div class="note">
        â„¹ï¸ å–å¾— API Keyï¼šå‰å¾€ <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a> 
        â†’ å•Ÿç”¨ YouTube Data API v3 â†’ å»ºç«‹æ†‘è­‰ï¼ˆAPI é‡‘é‘°ï¼‰
        <br><small style="margin-top:6px;display:block">â€» API Key åªå­˜åœ¨æ‚¨çš„ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨</small>
      </div>
    </div>

    <h3 style="color:#374151;margin:20px 0 12px">ğŸ¯ æœå°‹æ¢ä»¶</h3>
    <div class="controls">
      <div>
        <label>åœ°å€</label>
        <select id="region">
          <option value="TW">å°ç£ ğŸ‡¹ğŸ‡¼</option>
          <option value="HK">é¦™æ¸¯ ğŸ‡­ğŸ‡°</option>
          <option value="SG">æ–°åŠ å¡ ğŸ‡¸ğŸ‡¬</option>
          <option value="JP">æ—¥æœ¬ ğŸ‡¯ğŸ‡µ</option>
          <option value="KR">éŸ“åœ‹ ğŸ‡°ğŸ‡·</option>
          <option value="US">ç¾åœ‹ ğŸ‡ºğŸ‡¸</option>
        </select>
      </div>
      <div>
        <label>èªè¨€</label>
        <select id="lang">
          <option value="zh-Hant">ç¹é«”ä¸­æ–‡</option>
          <option value="zh-Hans">ç°¡é«”ä¸­æ–‡</option>
          <option value="en">è‹±æ–‡</option>
          <option value="ja">æ—¥æ–‡</option>
          <option value="ko">éŸ“æ–‡</option>
        </select>
      </div>
      <div>
        <label>å“é¡é—œéµå­—</label>
        <input id="category" placeholder="ä¾‹å¦‚ï¼šç§‘æŠ€ã€ç¾é£Ÿã€æ—…éŠ" value="ç§‘æŠ€" />
      </div>
      <div>
        <label>çµæœæ•¸é‡</label>
        <select id="maxResults">
          <option value="20">20</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn-primary" onclick="searchChannels()">ğŸ” é–‹å§‹åˆ†æ</button>
      <button class="btn-secondary" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡º CSV</button>
      <button class="btn-secondary" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
    </div>

    <div id="status"></div>

    <div style="overflow-x:auto">
      <table id="resultsTable" style="display:none">
        <thead>
          <tr>
            <th onclick="sortTable('rank')">#</th>
            <th onclick="sortTable('title')">é »é“</th>
            <th onclick="sortTable('tier')">è©•ç´š</th>
            <th onclick="sortTable('subscriberCount')">è¨‚é–±æ•¸</th>
            <th onclick="sortTable('viewCount')">ç¸½è§€çœ‹</th>
            <th onclick="sortTable('videoCount')">å½±ç‰‡æ•¸</th>
            <th onclick="sortTable('avgViews')">å¹³å‡è§€çœ‹</th>
            <th onclick="sortTable('score')">ç¶œåˆåˆ†æ•¸</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API_KEY_STORAGE = 'vgv_youtube_api_key';
let currentResults = [];
let sortColumn = 'score';
let sortAsc = false;

// è¼‰å…¥å·²å„²å­˜çš„ API Key
window.onload = function() {
  const saved = localStorage.getItem(API_KEY_STORAGE);
  if(saved) document.getElementById('apiKey').value = saved;
};

function saveApiKey() {
  const key = document.getElementById('apiKey').value.trim();
  if(!key) {
    showStatus('è«‹è¼¸å…¥ API Key', 'error');
    return;
  }
  localStorage.setItem(API_KEY_STORAGE, key);
  showStatus('âœ… API Key å·²å„²å­˜', 'success');
}

function showStatus(msg, type = 'loading') {
  const div = document.getElementById('status');
  div.className = 'status ' + type;
  div.textContent = msg;
  div.style.display = 'block';
}

async function searchChannels() {
  const apiKey = localStorage.getItem(API_KEY_STORAGE);
  if(!apiKey) {
    showStatus('âŒ è«‹å…ˆè¨­å®š API Key', 'error');
    return;
  }

  const region = document.getElementById('region').value;
  const lang = document.getElementById('lang').value;
  const category = document.getElementById('category').value.trim();
  const maxResults = document.getElementById('maxResults').value;

  showStatus('ğŸ” æ­£åœ¨æœå°‹é »é“...', 'loading');
  currentResults = [];

  try {
    // 1. æœå°‹é »é“
    const searchUrl = `https://www.googleapis.com/youtube/v3/search?` +
      `part=snippet&type=channel&regionCode=${region}&relevanceLanguage=${lang}` +
      `&q=${encodeURIComponent(category)}&maxResults=${maxResults}&key=${apiKey}`;
    
    const searchRes = await fetch(searchUrl);
    if(!searchRes.ok) throw new Error('æœå°‹å¤±æ•—ï¼š' + searchRes.status);
    const searchData = await searchRes.json();

    if(!searchData.items || searchData.items.length === 0) {
      showStatus('âŒ æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é »é“', 'error');
      return;
    }

    const channelIds = searchData.items.map(item => item.snippet.channelId).join(',');

    // 2. å–å¾—é »é“è©³ç´°è³‡è¨Š
    const channelsUrl = `https://www.googleapis.com/youtube/v3/channels?` +
      `part=snippet,statistics&id=${channelIds}&key=${apiKey}`;
    
    const channelsRes = await fetch(channelsUrl);
    if(!channelsRes.ok) throw new Error('å–å¾—é »é“è³‡æ–™å¤±æ•—');
    const channelsData = await channelsRes.json();

    // 3. è™•ç†çµæœ
    currentResults = channelsData.items.map((ch, idx) => {
      const stats = ch.statistics;
      const snippet = ch.snippet;
      
      const subscriberCount = parseInt(stats.subscriberCount || 0);
      const viewCount = parseInt(stats.viewCount || 0);
      const videoCount = parseInt(stats.videoCount || 1);
      const avgViews = Math.round(viewCount / videoCount);
      
      // ç°¡å–®è©•åˆ†ï¼ˆå¯è‡ªè¨‚ï¼‰
      let score = 0;
      score += Math.min(subscriberCount / 10000, 50); // è¨‚é–±æ•¸ï¼ˆæœ€é«˜50åˆ†ï¼‰
      score += Math.min(avgViews / 1000, 30); // å¹³å‡è§€çœ‹ï¼ˆæœ€é«˜30åˆ†ï¼‰
      score += Math.min(videoCount / 10, 20); // å½±ç‰‡æ•¸ï¼ˆæœ€é«˜20åˆ†ï¼‰
      score = Math.round(score);

      let tier = 'D';
      if(score >= 80) tier = 'A';
      else if(score >= 65) tier = 'B';
      else if(score >= 50) tier = 'C';

      return {
        rank: idx + 1,
        channelId: ch.id,
        title: snippet.title,
        customUrl: snippet.customUrl || '',
        thumbnail: snippet.thumbnails.default.url,
        subscriberCount,
        viewCount,
        videoCount,
        avgViews,
        score,
        tier
      };
    });

    sortColumn = 'score';
    sortAsc = false;
    renderTable();
    showStatus(`âœ… æ‰¾åˆ° ${currentResults.length} å€‹é »é“`, 'success');

  } catch(error) {
    console.error(error);
    showStatus('âŒ éŒ¯èª¤ï¼š' + error.message, 'error');
  }
}

function renderTable() {
  const tbody = document.getElementById('resultsBody');
  const table = document.getElementById('resultsTable');
  
  if(currentResults.length === 0) {
    table.style.display = 'none';
    return;
  }

  // æ’åº
  const sorted = [...currentResults].sort((a, b) => {
    let av = a[sortColumn];
    let bv = b[sortColumn];
    
    if(sortColumn === 'title' || sortColumn === 'tier') {
      return sortAsc ? 
        String(av).localeCompare(String(bv)) : 
        String(bv).localeCompare(String(av));
    }
    
    return sortAsc ? av - bv : bv - av;
  });

  tbody.innerHTML = sorted.map(ch => `
    <tr>
      <td class="number">${ch.rank}</td>
      <td>
        <div class="channel-cell">
          <img src="${ch.thumbnail}" class="channel-thumb" alt="">
          <div>
            <a href="https://www.youtube.com/channel/${ch.channelId}" 
               target="_blank" class="channel-name link">${escapeHtml(ch.title)}</a>
            <div class="channel-id">${escapeHtml(ch.customUrl || ch.channelId)}</div>
          </div>
        </div>
      </td>
      <td><span class="tier tier-${ch.tier}">${ch.tier}</span></td>
      <td class="number">${formatNumber(ch.subscriberCount)}</td>
      <td class="number">${formatNumber(ch.viewCount)}</td>
      <td class="number">${formatNumber(ch.videoCount)}</td>
      <td class="number">${formatNumber(ch.avgViews)}</td>
      <td class="number">${ch.score}</td>
    </tr>
  `).join('');

  table.style.display = 'table';
}

function sortTable(column) {
  if(sortColumn === column) {
    sortAsc = !sortAsc;
  } else {
    sortColumn = column;
    sortAsc = false;
  }
  renderTable();
}

function formatNumber(num) {
  if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
  if(num >= 1000) return (num/1000).toFixed(1) + 'K';
  return num.toString();
}

function escapeHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function exportCSV() {
  if(currentResults.length === 0) {
    showStatus('âŒ æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º', 'error');
    return;
  }

  const headers = ['æ’å','è©•ç´š','é »é“åç¨±','é »é“ID','è¨‚é–±æ•¸','ç¸½è§€çœ‹','å½±ç‰‡æ•¸','å¹³å‡è§€çœ‹','ç¶œåˆåˆ†æ•¸'];
  const rows = currentResults.map(ch => [
    ch.rank,
    ch.tier,
    `"${ch.title.replace(/"/g,'""')}"`,
    ch.channelId,
    ch.subscriberCount,
    ch.viewCount,
    ch.videoCount,
    ch.avgViews,
    ch.score
  ]);

  const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
  const blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `VGV_YouTubeåˆ†æ_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  showStatus('âœ… CSV å·²åŒ¯å‡º', 'success');
}

function clearResults() {
  currentResults = [];
  document.getElementById('resultsTable').style.display = 'none';
  document.getElementById('status').style.display = 'none';
}
</script>
</body>
</html>