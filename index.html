<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VGV KOL Radar Engine（完整版修正版）</title>
</head>
<body>
<script>
// ================================
//  VGV KOL Radar Engine (Fixed)
// ================================

// ===== API BASE SAFE SETUP =====
const LS_API_BASE = "VGV_API_BASE";
const DEFAULT_API_BASE = "https://youtube.aaron-9b6.workers.dev";

let API_BASE = localStorage.getItem(LS_API_BASE) || DEFAULT_API_BASE;
if (!API_BASE) API_BASE = DEFAULT_API_BASE;

// 安全儲存 API BASE
function saveApiBase(newValue) {
  let v = (newValue || "").trim();
  if (v.endsWith("/")) v = v.slice(0, -1);

  if (!v) {
    localStorage.removeItem(LS_API_BASE);
    API_BASE = DEFAULT_API_BASE;
    return { ok: true, message: "已恢復為預設 Worker API Base" };
  }

  localStorage.setItem(LS_API_BASE, v);
  API_BASE = v;
  return { ok: true, message: "已儲存新的 Worker API Base" };
}

// ===== 安全 Fetch 包裝器（避免 <!DOCTYPE> JSON 錯誤） =====
async function safeFetchJSON(url) {
  const response = await fetch(url, { cache: "no-store" });

  const contentType = response.headers.get("content-type") || "";

  if (!response.ok) {
    const text = await response.text();
    throw new Error("HTTP " + response.status + " - " + text.slice(0, 200));
  }

  if (!contentType.includes("application/json")) {
    const text = await response.text();
    throw new Error("API 回傳非 JSON：\n" + text.slice(0, 200));
  }

  return response.json();
}

// ===== 測試連線 =====
async function ping() {
  try {
    const data = await safeFetchJSON(API_BASE + "/ping");
    return { ok: true, data };
  } catch (err) {
    return { ok: false, error: err.message };
  }
}

// ===== 取得 TOP100 =====
async function fetchTop100(params) {
  const qs = new URLSearchParams(params).toString();
  const url = API_BASE + "/top100?" + qs;

  return safeFetchJSON(url);
}

console.log("VGV Radar Engine Loaded");
</script>

<h2>VGV Radar Engine 修正版已載入</h2>
<p>請將此檔案覆蓋你的 index.html 使用。</p>

</body>
</html>
